<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 新国创</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="js/style.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/components.js"></script>
    <style>
        /* Force table borders */
        .el-table--border .el-table__inner-wrapper::after,
        .el-table--border::after,
        .el-table--border::before,
        .el-table__inner-wrapper::before {
            background-color: #dcdfe6;
        }

        .el-table__border-left-patch {
            background-color: #dcdfe6;
        }

        .el-table--border .el-table__cell {
            border-right: 1px solid #dcdfe6;
        }

        .el-table th.el-table__cell {
            background-color: #f5f7fa;
            color: #606266;
            font-weight: bold;
            border-bottom: 1px solid #dcdfe6 !important;
        }

        .el-table td.el-table__cell {
            border-bottom: 1px solid #dcdfe6 !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-config-provider :locale="locale">
            <div class="main-layout">
                <side-menu active="users"></side-menu>
                <div class="content">
                    <layout-header title="用户管理"></layout-header>

                    <div class="page-container">
                        <div style="display:flex; align-items:center; margin-bottom:15px;">
                            <el-input v-model="query" placeholder="ID/手机号/昵称" style="width: 200px; margin-right: 10px;"
                                clearable @clear="fetchData(1)" @keyup.enter="fetchData(1)"></el-input>
                            <el-button type="primary" @click="fetchData(1)">搜索</el-button>
                        </div>

                        <el-table :data="list" border stripe v-loading="loading">
                            <el-table-column prop="id" label="ID" width="80"></el-table-column>
                            <el-table-column prop="invite_code" label="邀请码" width="100"></el-table-column>
                            <el-table-column prop="nickname" label="昵称"></el-table-column>
                            <el-table-column prop="mobile" label="手机号">
                                <template #default="scope">
                                    {{ scope.row.mobile }}
                                    <el-tag v-if="scope.row.is_frozen == 1" type="danger" size="small"
                                        style="margin-left:5px">冻结</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column prop="level" label="等级" width="80">
                                <template #default="scope">{{ formatLevel(scope.row.level) }}</template>
                            </el-table-column>
                            <el-table-column label="上级(推荐人)" width="150">
                                <template #default="scope">
                                    <div v-if="scope.row.parent_mobile">
                                        <div>{{ scope.row.parent_nickname }}</div>
                                        <div style="font-size:12px;color:#999">{{ scope.row.parent_mobile }}</div>
                                    </div>
                                    <div v-else>-</div>
                                </template>
                            </el-table-column>
                            <el-table-column label="左区(L)" width="140">
                                <template #default="scope">
                                    <div>业绩: {{ parseFloat(scope.row.left_total||0).toLocaleString() }}</div>
                                    <div style="font-size:12px;color:#999">直推: {{ scope.row.left_directs }}</div>
                                </template>
                            </el-table-column>
                            <el-table-column label="右区(R)" width="140">
                                <template #default="scope">
                                    <div>业绩: {{ parseFloat(scope.row.right_total||0).toLocaleString() }}</div>
                                    <div style="font-size:12px;color:#999">直推: {{ scope.row.right_directs }}</div>
                                </template>
                            </el-table-column>
                            <el-table-column label="余额">
                                <template #default="scope">{{ parseFloat(scope.row.balance||0).toFixed(2) }}</template>
                            </el-table-column>
                            <el-table-column label="流量分">
                                <template #default="scope">{{ parseFloat(scope.row.traffic_points||0).toFixed(2)
                                    }}</template>
                            </el-table-column>
                            <el-table-column label="购物券">
                                <template #default="scope">{{ parseFloat(scope.row.vouchers||0).toFixed(2) }}</template>
                            </el-table-column>
                            <el-table-column label="操作" width="280">
                                <template #default="scope">
                                    <el-button size="small" type="primary" @click="openEdit(scope.row)">编辑</el-button>
                                    <el-button size="small" type="success"
                                        @click="openRecharge(scope.row)">充值</el-button>
                                    <el-button size="small" type="warning" @click="openDetail(scope.row)">明细</el-button>
                                    <el-button size="small" type="info" @click="openTeam(scope.row)">团队</el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- Pagination -->
                        <div style="margin-top: 30px; text-align: center;">
                            <el-pagination background layout="prev, pager, next" :total="total" :page-size="limit"
                                @current-change="handlePageChange"></el-pagination>
                        </div>
                    </div>

                    <!-- Dialog -->
                    <el-dialog v-model="showRecharge" title="充值/扣补" width="400px">
                        <el-form :model="rechargeForm" label-width="80px">
                            <el-form-item label="类型">
                                <el-radio-group v-model="rechargeForm.type">
                                    <el-radio label="balance">余额</el-radio>
                                    <el-radio label="traffic_points">流量分</el-radio>
                                    <el-radio label="vouchers">购物券</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <el-form-item label="变动金额">
                                <el-input v-model="rechargeForm.amount" placeholder="正数为充值，负数为扣除"></el-input>
                                <div style="font-size:12px;color:#999;">例: 1000 或 -500</div>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="showRecharge = false">取消</el-button>
                            <el-button type="primary" @click="doRecharge">确定</el-button>
                        </template>
                    </el-dialog>

                    <!-- Detail Dialog -->
                    <el-dialog v-model="showDetail" title="资金明细" width="700px">
                        <div style="margin-bottom: 15px;">
                            <el-date-picker v-model="detailDateRange" type="daterange" range-separator="至"
                                start-placeholder="开始日期" end-placeholder="结束日期" value-format="YYYY-MM-DD"
                                @change="fetchDetailLog" />
                        </div>
                        <el-table :data="detailList" border stripe height="400">
                            <el-table-column prop="created_at" label="时间" width="160"></el-table-column>
                            <el-table-column prop="type" label="类型" width="120">
                                <template #default="scope">{{ formatType(scope.row.type) }}</template>
                            </el-table-column>
                            <el-table-column prop="asset_type" label="资产" width="100">
                                <template #default="scope">
                                    <span v-if="scope.row.asset_type=='balance'">余额</span>
                                    <span v-else-if="scope.row.asset_type=='traffic_points'">流量分</span>
                                    <span v-else-if="scope.row.asset_type=='vouchers'">购物券</span>
                                    <span v-else>{{ scope.row.asset_type }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="amount" label="金额" width="100">
                                <template #default="scope">
                                    <span :style="{color: parseFloat(scope.row.amount)>0?'red':'green'}">
                                        {{ parseFloat(scope.row.amount)>0 ? '+' : '' }}{{
                                        (parseFloat(scope.row.amount)).toFixed(2) }}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="memo" label="备注"></el-table-column>
                        </el-table>
                    </el-dialog>

                    <!-- Edit Dialog -->
                    <el-dialog v-model="showEdit" title="编辑用户" width="500px">
                        <el-form :model="editForm" label-width="100px">
                            <el-form-item label="昵称">
                                <el-input v-model="editForm.nickname"></el-input>
                            </el-form-item>
                            <el-form-item label="手机号">
                                <el-input v-model="editForm.mobile"></el-input>
                            </el-form-item>
                            <el-form-item label="上级ID">
                                <el-input v-model="editForm.parent_id" placeholder="修改上级可能影响层级"></el-input>
                            </el-form-item>
                            <el-form-item label="区域位置">
                                <el-radio-group v-model="editForm.position">
                                    <el-radio label="L">左区</el-radio>
                                    <el-radio label="R">右区</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            <el-form-item label="重置密码">
                                <el-input v-model="editForm.password" placeholder="留空则不修改"></el-input>
                            </el-form-item>
                            <el-form-item label="账户状态">
                                <el-radio-group v-model="editForm.is_frozen">
                                    <el-radio :label="0">正常</el-radio>
                                    <el-radio :label="1">冻结</el-radio>
                                </el-radio-group>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <el-button @click="showEdit = false">取消</el-button>
                            <el-button type="primary" @click="doEdit">保存</el-button>
                        </template>
                    </el-dialog>

                    <!-- Team Dialog -->
                    <el-dialog v-model="showTeam" title="团队结构" width="800px">
                        <el-tree :props="defaultProps" :load="loadTeamNode" lazy node-key="id"
                            :default-expanded-keys="teamExpandedKeys" v-if="showTeam">
                            <template #default="{ node, data }">
                                <span class="custom-tree-node">
                                    <span>{{ node.label }}</span>
                                    <span style="margin-left: 10px; font-size: 12px; color: #666;">
                                        <el-tag size="small" :type="data.data.level>0?'warning':'info'">{{
                                            formatLevel(data.data.level) }}</el-tag>
                                        <span style="margin-left:5px;">左区: {{
                                            parseFloat(data.data.left_total).toFixed(2) }}</span>
                                        <span style="margin-left:5px;">右区: {{
                                            parseFloat(data.data.right_total).toFixed(2) }}</span>
                                    </span>
                                </span>
                            </template>
                        </el-tree>
                    </el-dialog>
                </div>
            </div>

            <script>
                const { createApp, ref, reactive, onMounted } = Vue;

                createApp({
                    components: { SideMenu: window.SideMenu, LayoutHeader: window.LayoutHeader },
                    setup() {
                        const locale = ElementPlusLocaleZhCn;
                        const list = ref([]);
                        const loading = ref(false);
                        const query = ref('');
                        const page = ref(1);
                        const limit = ref(20);
                        const total = ref(0);

                        const fetchData = async (p = 1) => {
                            if (typeof p === 'number') page.value = p;
                            loading.value = true;
                            const res = await window.req(`users&search=${query.value}&page=${page.value}`, {}, 'GET');
                            loading.value = false;
                            if (res) {
                                list.value = res.data.list;
                                total.value = parseInt(res.data.total);
                            }
                        };

                        const handlePageChange = (val) => {
                            fetchData(val);
                        };

                        // Recharge Logic
                        const showRecharge = ref(false);
                        const rechargeForm = reactive({ user_id: 0, amount: '', type: 'balance' });
                        const openRecharge = (row) => {
                            rechargeForm.user_id = row.id;
                            rechargeForm.amount = '';
                            showRecharge.value = true;
                        };
                        const doRecharge = async () => {
                            if (!rechargeForm.amount) return;
                            await window.req('recharge', rechargeForm);
                            showRecharge.value = false;
                            ElementPlus.ElMessage.success('操作成功');
                            fetchData();
                        };

                        // Edit Logic
                        const showEdit = ref(false);
                        const editForm = reactive({ id: 0, nickname: '', mobile: '', parent_id: '', position: '', password: '', is_frozen: 0 });

                        const openEdit = (row) => {
                            editForm.id = row.id;
                            editForm.nickname = row.nickname;
                            editForm.mobile = row.mobile;
                            editForm.parent_id = row.parent_id;
                            editForm.position = row.position || 'L';
                            editForm.is_frozen = row.is_frozen !== undefined ? row.is_frozen : 0;
                            editForm.password = '';
                            showEdit.value = true;
                        };

                        const doEdit = async () => {
                            await window.req('update_user', editForm);
                            showEdit.value = false;
                            ElementPlus.ElMessage.success('保存成功');
                            fetchData();
                        };

                        onMounted(() => {
                            window.checkLogin();
                            fetchData();
                        });

                        // Detail Logic
                        const showDetail = ref(false);
                        const detailList = ref([]);
                        const detailDateRange = ref([]);
                        const currentDetailUserId = ref(0);

                        const fetchDetailLog = async () => {
                            if (!currentDetailUserId.value) return;
                            let url = `user_transactions&user_id=${currentDetailUserId.value}`;
                            if (detailDateRange.value && detailDateRange.value.length === 2) {
                                url += `&start_date=${detailDateRange.value[0]}&end_date=${detailDateRange.value[1]}`;
                            }
                            const res = await window.req(url);
                            if (res) detailList.value = res.data;
                        };

                        const openDetail = (row) => {
                            currentDetailUserId.value = row.id;
                            detailDateRange.value = []; // Reset
                            fetchDetailLog();
                            showDetail.value = true;
                        };

                        // Team Logic
                        const showTeam = ref(false);
                        const teamExpandedKeys = ref([]);
                        const currentTeamRootId = ref(0);
                        const defaultProps = {
                            label: 'label',
                            children: 'children',
                            isLeaf: 'leaf'
                        };

                        const openTeam = (row) => {
                            currentTeamRootId.value = row.id;
                            teamExpandedKeys.value = [row.id];
                            showTeam.value = true;
                        };

                        const loadTeamNode = async (node, resolve) => {
                            if (node.level === 0) {
                                // Load Root
                                if (!currentTeamRootId.value) return resolve([]);
                                const res = await window.req(`user_team&id=${currentTeamRootId.value}`);
                                if (res && res.data) resolve(res.data);
                                else resolve([]);
                            } else {
                                // Load Children
                                const res = await window.req(`user_team&parent_id=${node.data.id}`);
                                if (res && res.data) resolve(res.data);
                                else resolve([]);
                            }
                        };

                        const formatType = (type) => {
                            const map = {
                                'release': '签到释放',
                                'buy': '购物消费',
                                'admin_recharge': '管理员操作',
                                'exchange': '积分兑换',
                                'withdraw': '余额提现',
                                'withdraw_refund': '提现退回',
                                'referral_bonus': '推荐奖励',
                                'team_bonus': '团队奖励',
                                'dynamic_bonus': '动态加速',
                                'transfer_in': '转入',
                                'transfer_out': '转出'
                            };
                            return map[type] || type;
                        };

                        return {
                            list, loading, query, fetchData,
                            page, limit, total, handlePageChange,
                            showRecharge, rechargeForm, openRecharge, doRecharge,
                            showEdit, editForm, openEdit, doEdit,
                            showDetail, detailList, openDetail, formatType, detailDateRange, fetchDetailLog,
                            showTeam, openTeam, loadTeamNode, defaultProps, teamExpandedKeys,
                            formatLevel: window.formatUtils.formatLevel,
                            locale
                        };
                    }
                }).use(ElementPlus).mount('#app');
            </script>
</body>

</html>