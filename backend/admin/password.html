<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改密码 - 新国创</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="js/style.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/components.js"></script>
</head>

<body>
    <div id="app" class="main-layout">
        <side-menu active="password"></side-menu>
        <div class="content">
            <layout-header title="修改密码"></layout-header>

            <div class="page-container" style="max-width: 600px;">
                <el-form :model="form" label-width="120px" ref="formRef" :rules="rules">
                    <el-form-item label="原密码" prop="old_password">
                        <el-input v-model="form.old_password" type="password" show-password></el-input>
                    </el-form-item>
                    <el-form-item label="新密码" prop="new_password">
                        <el-input v-model="form.new_password" type="password" show-password></el-input>
                    </el-form-item>
                    <el-form-item label="确认新密码" prop="confirm_password">
                        <el-input v-model="form.confirm_password" type="password" show-password></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="submitForm" :loading="loading">确认修改</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        createApp({
            components: { SideMenu: window.SideMenu, LayoutHeader: window.LayoutHeader },
            setup() {
                const formRef = ref(null);
                const loading = ref(false);
                const form = reactive({
                    old_password: '',
                    new_password: '',
                    confirm_password: ''
                });

                const validatePass2 = (rule, value, callback) => {
                    if (value === '') {
                        callback(new Error('请再次输入密码'));
                    } else if (value !== form.new_password) {
                        callback(new Error('两次输入密码不一致!'));
                    } else {
                        callback();
                    }
                };

                const rules = {
                    old_password: [{ required: true, message: '请输入原密码', trigger: 'blur' }],
                    new_password: [{ required: true, message: '请输入新密码', trigger: 'blur' }, { min: 6, message: '密码长度不能少于6位', trigger: 'blur' }],
                    confirm_password: [{ validator: validatePass2, trigger: 'blur' }]
                };

                const submitForm = async () => {
                    if (!formRef.value) return;
                    await formRef.value.validate(async (valid) => {
                        if (valid) {
                            loading.value = true;
                            // Call API
                            // There's no specific 'password' endpoint yet, assuming action=change_password
                            try {
                                const res = await window.req('change_password', {
                                    old_password: form.old_password,
                                    new_password: form.new_password
                                }, 'POST');

                                if (res) {
                                    ElementPlus.ElMessage.success('密码修改成功，请重新登录');
                                    setTimeout(() => {
                                        localStorage.removeItem('admin_login');
                                        window.location.href = 'login.html';
                                    }, 1500);
                                }
                            } catch (e) {
                                // checkLogin/req handles error
                            } finally {
                                loading.value = false;
                            }
                        }
                    });
                };

                onMounted(() => {
                    window.checkLogin();
                });

                return {
                    form, rules, formRef, loading, submitForm
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>

</html>