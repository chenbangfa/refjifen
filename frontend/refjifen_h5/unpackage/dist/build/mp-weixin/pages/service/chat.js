(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/service/chat"],{"245e":function(t,e,n){},"6f08":function(t,e,n){"use strict";(function(t,e){var a=n("47a9");n("a82b");a(n("3240"));var o=a(n("728b"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(o.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},"728b":function(t,e,n){"use strict";n.r(e);var a=n("d801"),o=n("b3db");for(var i in o)["default"].indexOf(i)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(i);n("c8ec");var r=n("828b"),c=Object(r["a"])(o["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],void 0);e["default"]=c.exports},b3db:function(t,e,n){"use strict";n.r(e);var a=n("baa3"),o=n.n(a);for(var i in a)["default"].indexOf(i)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(i);e["default"]=o.a},baa3:function(t,e,n){"use strict";(function(t){var a=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=a(n("7eb4")),i=a(n("ee10")),r={data:function(){return{messages:[],inputText:"",scrollTop:0,userAvatar:"",timer:null}},onLoad:function(){this.fetchHistory(),this.startPolling()},onUnload:function(){this.stopPolling()},methods:{fetchHistory:function(){var e=this;return(0,i.default)(o.default.mark((function n(){var a,i,r;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,t.$api("service.php?action=history");case 3:a=n.sent,200==a.code&&(i=a.data.length,r=e.messages.length,e.messages=a.data,i>r&&e.scrollToBottom()),n.next=9;break;case 7:n.prev=7,n.t0=n["catch"](0);case 9:case"end":return n.stop()}}),n,null,[[0,7]])})))()},startPolling:function(){var t=this;this.timer=setInterval((function(){t.fetchHistory()}),3e3)},stopPolling:function(){this.timer&&clearInterval(this.timer)},scrollToBottom:function(){var t=this;this.scrollTop=this.scrollTop+1,this.$nextTick((function(){t.scrollTop=9999999}))},sendText:function(){var e=this;return(0,i.default)(o.default.mark((function n(){var a;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(e.inputText.trim()){n.next=2;break}return n.abrupt("return");case 2:return a=e.inputText,e.inputText="",n.prev=4,n.next=7,t.$api("service.php?action=send","POST",{content:a,type:"text"});case 7:e.fetchHistory(),e.scrollToBottom(),n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](4),t.showToast({title:"发送失败",icon:"none"});case 14:case"end":return n.stop()}}),n,null,[[4,11]])})))()},chooseImage:function(){var e=this;t.chooseImage({count:1,success:function(t){var n=t.tempFilePaths[0];e.uploadAndSend(n)}})},uploadAndSend:function(e){var n=this;t.showLoading({title:"发送中..."}),t.uploadFile({url:"https://ref.tajian.cc/backend/api/service.php?action=upload",filePath:e,name:"file",header:{Authorization:"Bearer "+t.getStorageSync("token")},success:function(e){t.hideLoading();try{var a=JSON.parse(e.data);200==a.code?t.$api("service.php?action=send","POST",{content:a.data.url,type:"image"}).then((function(){n.fetchHistory(),n.scrollToBottom()})):t.showToast({title:a.message||"上传失败",icon:"none"})}catch(o){t.showToast({title:"解析失败",icon:"none"})}},fail:function(e){t.hideLoading(),console.error(e),t.showToast({title:"上传出错",icon:"none"})}})},previewImage:function(e){t.previewImage({urls:[e]})}}};e.default=r}).call(this,n("df3c")["default"])},c8ec:function(t,e,n){"use strict";var a=n("245e"),o=n.n(a);o.a},d801:function(t,e,n){"use strict";n.d(e,"b",(function(){return a})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){}));var a=function(){var t=this.$createElement;this._self._c},o=[]}},[["6f08","common/runtime","common/vendor"]]]);