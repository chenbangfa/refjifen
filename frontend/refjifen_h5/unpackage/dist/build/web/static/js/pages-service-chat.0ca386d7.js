(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-service-chat"],{"37f4":function(t,e,n){"use strict";n("6a54");var i=n("f5bd").default;Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,n("0c26");var a=i(n("2634")),o=i(n("2fdc")),r={data:function(){return{messages:[],inputText:"",scrollTop:0,userAvatar:"",timer:null}},onLoad:function(){this.fetchHistory(),this.startPolling()},onUnload:function(){this.stopPolling()},methods:{fetchHistory:function(){var t=this;return(0,o.default)((0,a.default)().mark((function e(){var n,i,o;return(0,a.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,uni.$api("service.php?action=history");case 3:n=e.sent,200==n.code&&(i=n.data.length,o=t.messages.length,t.messages=n.data,i>o&&t.scrollToBottom()),e.next=9;break;case 7:e.prev=7,e.t0=e["catch"](0);case 9:case"end":return e.stop()}}),e,null,[[0,7]])})))()},startPolling:function(){var t=this;this.timer=setInterval((function(){t.fetchHistory()}),3e3)},stopPolling:function(){this.timer&&clearInterval(this.timer)},scrollToBottom:function(){var t=this;this.scrollTop=this.scrollTop+1,this.$nextTick((function(){t.scrollTop=9999999}))},sendText:function(){var t=this;return(0,o.default)((0,a.default)().mark((function e(){var n;return(0,a.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.inputText.trim()){e.next=2;break}return e.abrupt("return");case 2:return n=t.inputText,t.inputText="",e.prev=4,e.next=7,uni.$api("service.php?action=send","POST",{content:n,type:"text"});case 7:t.fetchHistory(),t.scrollToBottom(),e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](4),uni.showToast({title:"发送失败",icon:"none"});case 14:case"end":return e.stop()}}),e,null,[[4,11]])})))()},chooseImage:function(){var t=this;uni.chooseImage({count:1,success:function(e){var n=e.tempFilePaths[0];t.uploadAndSend(n)}})},uploadAndSend:function(t){var e=this;uni.showLoading({title:"发送中..."}),uni.uploadFile({url:"https://ref.tajian.cc/backend/api/service.php?action=upload",filePath:t,name:"file",header:{Authorization:"Bearer "+uni.getStorageSync("token")},success:function(t){uni.hideLoading();try{var n=JSON.parse(t.data);200==n.code?uni.$api("service.php?action=send","POST",{content:n.data.url,type:"image"}).then((function(){e.fetchHistory(),e.scrollToBottom()})):uni.showToast({title:n.message||"上传失败",icon:"none"})}catch(i){uni.showToast({title:"解析失败",icon:"none"})}},fail:function(t){uni.hideLoading(),console.error(t),uni.showToast({title:"上传出错",icon:"none"})}})},previewImage:function(t){uni.previewImage({urls:[t]})}}};e.default=r},3973:function(t,e,n){"use strict";var i=n("94b3"),a=n.n(i);a.a},"728b":function(t,e,n){"use strict";n.r(e);var i=n("7dad"),a=n("b3db");for(var o in a)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(o);n("3973");var r=n("828b"),s=Object(r["a"])(a["default"],i["b"],i["c"],!1,null,"13e92432",null,!1,i["a"],void 0);e["default"]=s.exports},"7dad":function(t,e,n){"use strict";n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return a})),n.d(e,"a",(function(){}));var i=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("v-uni-view",{staticClass:"chat-container"},[n("v-uni-scroll-view",{staticClass:"msg-list",staticStyle:{flex:"1",height:"0"},attrs:{"scroll-y":"true","scroll-top":t.scrollTop,"scroll-with-animation":!0}},[t._l(t.messages,(function(e,i){return n("v-uni-view",{key:i,staticClass:"msg-item",class:e.sender},[n("v-uni-view",{staticClass:"avatar",class:e.sender},[n("v-uni-text",{staticClass:"avatar-text"},[t._v(t._s("admin"==e.sender?"客服":"我"))])],1),"text"==e.type?n("v-uni-view",{staticClass:"content-bubble"},[t._v(" "+t._s(e.content)+" ")]):"image"==e.type?n("v-uni-view",{staticClass:"content-image",on:{click:function(n){arguments[0]=n=t.$handleEvent(n),t.previewImage(e.content)}}},[n("v-uni-image",{attrs:{src:e.content,mode:"widthFix"}})],1):t._e()],1)})),n("v-uni-view",{staticStyle:{height:"20px"},attrs:{id:"bottom"}})],2),n("v-uni-view",{staticClass:"input-area"},[n("v-uni-view",{staticClass:"icon-btn",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.chooseImage.apply(void 0,arguments)}}},[n("svg",{attrs:{viewBox:"0 0 24 24",width:"24",height:"24"}},[n("path",{attrs:{fill:"#666",d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"}})])]),n("v-uni-input",{staticClass:"input-box",attrs:{placeholder:"输入消息...","confirm-type":"send","adjust-position":!0},on:{confirm:function(e){arguments[0]=e=t.$handleEvent(e),t.sendText.apply(void 0,arguments)}},model:{value:t.inputText,callback:function(e){t.inputText=e},expression:"inputText"}}),n("v-uni-view",{staticClass:"send-btn",on:{click:function(e){arguments[0]=e=t.$handleEvent(e),t.sendText.apply(void 0,arguments)}}},[t._v("发送")])],1)],1)},a=[]},"94b3":function(t,e,n){var i=n("ddde");i.__esModule&&(i=i.default),"string"===typeof i&&(i=[[t.i,i,""]]),i.locals&&(t.exports=i.locals);var a=n("967d").default;a("5324a4fe",i,!0,{sourceMap:!1,shadowMode:!1})},b3db:function(t,e,n){"use strict";n.r(e);var i=n("37f4"),a=n.n(i);for(var o in i)["default"].indexOf(o)<0&&function(t){n.d(e,t,(function(){return i[t]}))}(o);e["default"]=a.a},ddde:function(t,e,n){var i=n("c86c");e=i(!1),e.push([t.i,".chat-container[data-v-13e92432]{background:#f5f5f5;height:100vh;display:flex;flex-direction:column;overflow:hidden}.msg-list[data-v-13e92432]{flex:1;height:0;box-sizing:border-box;padding:15px}.msg-item[data-v-13e92432]{display:flex;margin-bottom:20px;align-items:flex-start}.msg-item.user[data-v-13e92432]{flex-direction:row-reverse}.avatar[data-v-13e92432]{width:40px;height:40px;border-radius:4px;background:linear-gradient(135deg,#07c160,#10b981);display:flex;align-items:center;justify-content:center;flex-shrink:0}.avatar-text[data-v-13e92432]{font-size:12px;color:#fff;font-weight:700}.avatar.admin[data-v-13e92432]{background:linear-gradient(135deg,#3b82f6,#1d4ed8);margin-right:10px}.avatar.user[data-v-13e92432]{background:linear-gradient(135deg,#07c160,#10b981);margin-left:10px}.content-bubble[data-v-13e92432]{max-width:70%;padding:10px 14px;border-radius:8px;font-size:15px;line-height:1.4;position:relative;word-break:break-all}.msg-item.admin .content-bubble[data-v-13e92432]{background:#fff;color:#333}.msg-item.user .content-bubble[data-v-13e92432]{background:#95ec69;color:#000}.content-image[data-v-13e92432]{max-width:60%;border-radius:8px;overflow:hidden}.content-image uni-image[data-v-13e92432]{width:100%;max-width:200px;min-width:80px;display:block;border-radius:8px;background:#eee}.input-area[data-v-13e92432]{min-height:50px;background:#f7f7f7;border-top:1px solid #ddd;display:flex;align-items:center;padding:5px 10px;padding-bottom:constant(safe-area-inset-bottom);padding-bottom:env(safe-area-inset-bottom)}.input-box[data-v-13e92432]{flex:1;height:36px;background:#fff;border-radius:4px;padding:0 10px;font-size:14px;margin-bottom:0}.send-btn[data-v-13e92432]{width:60px;height:36px;line-height:36px;text-align:center;background:#07c160;color:#fff;border-radius:4px;margin-left:10px;font-size:14px}.icon-btn[data-v-13e92432]{width:40px;height:40px;display:flex;align-items:center;justify-content:center}",""]),t.exports=e}}]);