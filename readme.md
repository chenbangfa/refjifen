
# H5商业消费积分与双轨制管理系统 - 产品需求文档 (PRD)

| 项目名称 | 消费流量分H5平台 | 版本号 | V 1.0.0 |
| --- | --- | --- | --- |
| **技术栈** | 前端: H5 (Vue/Uniapp) / 后端: PHP + MySQL | **文档日期** | 2025-12-27 |

---

## 1. 核心业务架构定义

### 1.1 账户体系（独立双子星结构）

* **单一手机号对应双ID**：系统不再使用“一个用户两个钱包”的结构，而是采用“一个手机号对应两个独立的User_ID”。
* **主账户 (Master Account)**：手机号注册时生成的第一个ID。
* **子账户 (Sub Account)**：用户在个人中心手动激活生成的第二个ID。


* **数据关联**：两个账号在数据库中是两条完全独立的记录，通过字段 `linked_mobile` 关联。
* **层级关系**：子账户生成时，**必须强制**作为主账户的“下级”，安置在主账户的左区或右区（由主账户指定），贡献业绩给主账户。

### 1.2 资产定义

1. **余额 (Balance)**：可提现、可转账、可消费。来源：充值、签到释放(70%)。
2. **流量分 (Traffic Points)**：**核心资产**。不可转账、不可提现。来源：购买礼包赠送。用途：每日签到消耗。
3. **购物券 (Vouchers)**：不可提现。来源：签到释放(30%)。用途：仅限兑换商城使用。
4. **业绩值 (Performance)**：分左区业绩、右区业绩。记录该账户下级无限层级的**历史累计消费额**。

---

## 2. 详细功能模块需求

### 2.1 注册与登录模块

* **注册规则**：
* 手机号 + 短信验证码。
* **强制邀请制**：必须填写邀请码（或扫码自动填写），系统需绑定上下级关系。


* **登录与切换**：
* 使用手机号+密码/验证码登录。
* 登录后，若已激活子账户，顶部导航栏显示“切换账号”按钮，点击可无缝切换身份（无需重新输入密码）。


* **安全设置（新增）**：
* **支付密码**：在“安全中心”设置6位数字密码，**独立于登录密码**。涉及转账、提现操作时必须校验。



### 2.2 会员等级与充值体系

* **等级划分**：
* **金卡**：消费/充值 4,000元。获得 12,000 流量分（3倍杠杆）。
* **钻卡**：消费/充值 20,000元。获得 80,000 流量分（4倍杠杆）。


* **购买规则**：
* 商品单价固定（如4000元礼包），需一次性支付，不可拆分。
* 支付成功后，自动赋予对应流量分和会员等级。


* **复投逻辑**：
* 当流量分消耗殆尽，用户需再次购买礼包。
* 复投行为**增加流量分**，且**累加历史业绩**。



### 2.3 签到释放系统（核心算法）

* **签到入口**：首页明显的“每日签到”按钮。
* **前端防抖**：点击按钮后，按钮立即变灰（Disabled）并显示Loading状态，防止用户连续点击造成重复请求。
* **释放公式**：



*(注释：如果剩余分不足，则只释放剩余部分，随后账户归零)*
* **理论释放额计算逻辑**：
1. **基础释放**：
* 金卡：8元/天。
* 钻卡：80元/天。


2. **动态加速（双轨对碰）**：
* 获取当前账户的 `Min(左区历史累计业绩, 右区历史累计业绩)`。
* 查表确定释放额（需配置在后台）：
* 双区 ≥ 4,000：日返 40元
* 双区 ≥ 8,000：日返 80元
* 双区 ≥ 20,000：日返 150元
* 双区 ≥ 50,000：日返 300元
* ...
* 双区 ≥ 2,000万：日返 24,000元



* **分账逻辑**：
* **70%** 进入余额（可提现/转账）。
* **30%** 进入购物券（仅商城）。
* **100%** 数值从“流量分”中扣除。



### 2.4 财务流转模块

* **余额转账（新增）**：
* A账户 -> C账户（任意存在的用户ID）。
* 规则：金额必须是 **200的整数倍**。
* 流程：输入对方ID -> 校验对方姓名（脱敏显示如：张*三） -> 输入金额 -> **输入6位支付密码** -> 到账。


* **提现功能**：
* 规则：≥100元，且为100的倍数。
* 时效：T+1（次日处理）。
* 手续费：0元。



### 2.5 业绩计算逻辑（无限代）

* **触发机制**：每当有用户购买/复投成功时。
* **计算路径**：
* 系统获取该用户的“安置人”路径（Tree Path）。
* **向上递归**：从直接上级开始，一直追溯到根节点。
* **判断左右**：判断当前消费用户位于上级的左区还是右区，对应增加上级的 `left_performance` 或 `right_performance`。
* **历史累计**：业绩只增不减，终身累积。



### 3. 接口安全规范

1. **Token机制**：使用 JWT (Json Web Token) 进行身份验证，防止会话劫持。
2. **支付密码校验**：
* 转账接口 `POST /api/transfer/submit` 必须包含 `pay_password` 字段。
* 后端验证密码错误次数，连续错误5次锁定账户1小时。


3. **并发锁 (Locking)**：
* 在执行“签到”和“转账”操作时，**必须使用数据库排他锁 (For Update)** 或 Redis 原子锁。
* 防止 A用户只有 200元，同时发起两笔 200元转账请求导致余额变负。


---

## 4. 新增：双商城业务逻辑

### 4.1 商城通用基础功能 (Common E-commerce)

两个商城共用一套底层的商品管理和订单系统，但在支付和结算逻辑上完全隔离。

* **商品管理 (后台)**：
* 基础信息：标题、多图轮播、详情页（富文本）、库存、销量。
* **分区标识**：必须标记商品属于 `Zone_A (余额区)` 还是 `Zone_B (券区)`。
* 规格：支持单规格即可（根据业务复杂度决定是否做多SKU）。


* **收货地址**：用户增删改查收货地址，下单时选择。
* **物流系统**：
* 后台：管理员发货，录入快递公司+运单号。
* 前端：用户查看订单详情，调用快递100等API查询物流轨迹（或仅展示单号）。



### 4.2 余额商城 (Zone A - 业绩引擎)

**这是整个系统的发动机。用户的“消费”动作在这里完成，并触发流量分赠送。**

* **支付逻辑**：
* **扣款资产**：100% 账户余额 (Balance)。
* **安全验证**：**强制输入6位支付密码**。


* **购买即升级/赠送逻辑 (核心)**：
* 用户下单支付成功后，系统执行以下原子操作：
1. 扣除余额。
2. **生成流量分**：
* 若用户是金卡（或购买金卡区商品）：赠送 `订单金额 * 3` 的流量分。
* 若用户是钻卡（或购买钻卡区商品）：赠送 `订单金额 * 4` 的流量分。


3. **触发业绩向上结算**：将订单金额计入该用户上级（无限代）的对应区域（左/右）业绩。




* **限制**：
* 如需求所述，特定等级礼包需一次性消耗（例如必须买4000元的商品）。



### 4.3 消费券商城 (Zone B - 泡沫出口)

**这是系统的去库存区域。商品通常是高溢价产品。**

* **支付逻辑**：
* **扣款资产**：100% 消费券 (Vouchers)。
* **余额不足**：若券不足，**不可**使用现金补差价（根据你的“纯购物券支付”需求）。
* **安全验证**：输入6位支付密码。


* **业务影响**：
* 此商城消费**不产生**流量分。
* 此商城消费**不产生**团队业绩。
* 纯粹的资产消耗行为。



### 4.4 订单状态机 (Order State Machine)

由于没有在线支付回调，状态流转简化如下：

1. **待付款**：下单后暂未输入支付密码（保留15分钟，超时取消）。
2. **待发货**：余额/券扣除成功，等待管理员后台发货。
3. **待收货**：管理员录入运单号。
4. **已完成**：用户点击确认收货，或发货后7天自动确认。



## 5. 开发流程建议

### 第一阶段：核心模型搭建 (后端)

1. 搭建数据库。
2. 完成 `注册 -> 激活子账户 -> 建立上下级树状关系` 的逻辑。
3. 完成 `充值 -> 业绩向上冒泡 (Bubble Up)` 的算法。

### 第二阶段：资产与签到 (后端)

1. 编写签到脚本：`双轨业绩判断 -> 查表 -> 扣减积分/增加余额`。
2. **重点测试**：库存归零时的边界情况（即剩3元应发40元时，系统是否只发3元）。

### 第三阶段：前端交互与对接

1. H5页面开发（重点在“个人中心”和“团队树状图”）。
2. 对接转账接口，调试支付密码验证。
3. 前端防抖功能实装。
